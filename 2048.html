<!DOCTYPE html>
<html>
<head>
	<title>Jacob's 2048</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style type="text/css">
		body {		    
		    text-align: center;
		}
		.square {
	    float:left;
	    position: relative;
	    width: 20%;
	    padding-bottom : 20%;
	    margin:2.5%;
	    background-color:#FFE6CC;
	    overflow:hidden;
		}
		.number {
			
	    position:absolute;
	    height:90%;
	    width:90%;
	    padding: 5%;
	    font-weight:400;
	
		}
		.container {
			width:100%;
			max-width: 400px;
			position:relative;
		}
		.overblock {
			display:table-cell;
			position:absolute;
			z-index: 10; /*ensure it is on top when needed*/
			font-size:50px;
			vertical-align: middle;
			text-align: center;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="square">
		    <div class="number">
		    </div>
		</div>
		<div class="square">
		    <div class="number">              
		    </div>
		</div>
		<div class="square">
		    <div class="number">
		    </div>
		</div>
		<div class="square">
		    <div class="number">              
		    </div>
		</div>
		<div class="square">
		    <div class="number">
		    </div>
		</div>
		<div class="square">
		    <div class="number">              
		    </div>
		</div>
		<div class="square">
		    <div class="number">
		    </div>
		</div>
		<div class="square">
		    <div class="number">              
		    </div>
		</div>
		<div class="square">
		    <div class="number">
		    </div>
		</div>
		<div class="square">
		    <div class="number">              
		    </div>
		</div>
		<div class="square">
		    <div class="number">
		    </div>
		</div>
		<div class="square">
		    <div class="number">              
		    </div>
		</div>
		<div class="square">
		    <div class="number">
		    </div>
		</div>
		<div class="square">
		    <div class="number">              
		    </div>
		</div>
		<div class="square">
		    <div class="number">
		    </div>
		</div>
		<div class="square">
		    <div class="number">              
		    </div>
		</div>
	</div>	
	<table>
		<tr><td></td><td><button id="up">Up</button></td><td></td></tr>
		<tr><td><button id="left">Left</button></td><td></td><td><button id="right">Right</button></td></tr>
		<tr><td></td><td><button id="down">Down</button></td><td></td></tr>
	</table>
</body>
<!--add to after body, do not want JS to hinder load times -->
<script src="js-temp/jquery-1.11.3.min.js"></script>
<script>
//build object for blocks
var Block = function(element,value,position, gridObject) {
	this._element = element;
	this.Merged = false;
	this.Position = position;
	//javascript reference, does not take up extra memory
	//hence we can store the reference to grid object for easy coding
	this.GridObject = gridObject;	
	element.addClass("with-content");	
	this.AddOverBlock();
	this.Value = value;
	this.UpdateView();
}; //default constructor

Block.prototype.AddOverBlock = function() {
	var element = this._element;
	var overBlock = $('<div class="overblock"></div>');
	$("body").append(overBlock);
	this._displayBlock = overBlock;
	this.ResizeOverBlock();

};

Block.prototype.UpdateView = function() {
	this._displayBlock.text(this.Value);
}

Block.prototype.ResizeOverBlock = function() {
	var element = this._element;
	this._displayBlock.offset(element.offset())
		.height(element.height())
		.width(element.width())
		.css("padding",element.css("padding"));
}

Block.prototype.MoveLeft = function() {
	//cycle through all the left side and see if there's a merge
	//if not animate to move it
	var posX = this.Position.x;
	var posY = this.Position.y;
	var cont = true, boxesToMove = 0;
	var blocks = this.GridObject.Blocks;
	if(posX == 0) return;
	while(cont) {
		posX--;

		var block = blocks[posY][posX];
		if(block == null) {
			boxesToMove++;
		} else {
			cont = false;
			if(block.Value == this.Value && block.Merged == false) {
				//perform a merge
				boxesToMove++;
			} else {posX++;} //set back original position
		}
		if(posX <= 0) cont = false;
	}
	var timing = 50*boxesToMove;
	this.MoveTo({x:posX,y:posY}, timing);
};

Block.prototype.MoveTo = function(newPosition, timing) {
	//return if no change in position
	if(this.Position.y == newPosition.y && this.Position.x == newPosition.x) return;
	var $target = $("div.number:eq("+Grid.GetSeq(newPosition.y,newPosition.x)+")");
	var existing = this.GridObject.Blocks[newPosition.y][newPosition.x];
	var targetToDestroy = null;
	if(existing!=null) {
		//performing a merge
		this.Value = this.Value * 2;
		this.UpdateView();
		//targetToDestroy = existing._displayBlock;
		this.GridObject.RemoveBlock(newPosition);
		existing.Remove();
	}
	this._element.removeClass("with-content");
	this._element = $target.addClass("with-content");
	this.GridObject.UpdateBlockPosition(this.Position,newPosition,this);
	this.Position = newPosition;	
	$that = this;
	this._displayBlock.animate({
			left:$target.offset().left,
			top: $target.offset().top
		}, 
		timing,
		function(){
			//$that.UpdateView();
			//if(targetToDestroy!=null)targetToDestroy.remove();
		}
	);
}

Block.prototype.MergeWith = function(toElement) {
	this.SetValue(this.Value * 2);
	this.Merged = true;
	this._element.removeClass("with-content");
	this._element = toElement;
}

Block.prototype.Remove = function() {
	this._element.removeClass("with-content");
	//block should destroy after animation;
	this._displayBlock.remove();
	this.GridObject.RemoveBlock(this.Position);
};
//build object for grid
var Grid = function() {
	this.Blocks = [];
	for(var i=0 ; i < 4 ; i ++) {
		var subGrid = [null,null,null,null];
		this.Blocks.push(subGrid);
	}
	for(var i=0 ; i<2 ;i++) {
		this.AddRandomBlock();
	}
}; //default constructor

Grid.prototype.AddRandomBlock = function() {
	if($("div.number.with-content").length == 16) return;
	var $selector = [];
	while($selector.length == 0) {
		var elementNo = Math.floor(Math.random() * 16);
		$selector = $("div.number:eq("+elementNo+")").not(".with-content");	
	}
	var pos = Grid.GetPosition(elementNo);
	this.Blocks[pos.y][pos.x] = new Block($selector,2,pos, this); 
}

Grid.prototype.ResizeBlocks = function() {
	for(var i=0; i<4 ;i++) {
		for(var x=0; x<4; x++) {
			var block = this.Blocks[i][x];
			if(block!=null) block.ResizeOverBlock();
		}
	}
};

Grid.prototype.RemoveBlock = function(pos) {
	this.Blocks[pos.y][pos.x] = null;
};

Grid.prototype.UpdateBlockPosition = function(oldPosition,newPosition,block) {
	this.Blocks[newPosition.y][newPosition.x] = block;
	this.RemoveBlock(oldPosition);
};

Grid.prototype.MoveLeft = function() {
	for(var i=0;i<4;i++) {
		for(var x=0;x<4;x++) {
			var block = this.Blocks[i][x];
			if(block!=null && typeof block == "object") {
				block.MoveLeft();
			}
		}
	}
	this.AddRandomBlock();
}

Grid.GetSeq = function(y,x) {
	return (y*4)+x;
}

Grid.GetPosition = function(pos) {
	return {x:pos % 4, y: Math.floor(pos/4)};
}
</script>
<script>
var gridObject = new Grid();
//functions to control up down left or right
function swipeUp() {
	alert("swipe up");
};

function swipeDown() {
	alert("swipe down");
};

function swipeLeft() {
	gridObject.MoveLeft();
};

function swipeRight() {
	alert("swipe right");
};
</script>

<script>
//temporary scripts
//bind events
$(window).on("resize",function(){gridObject.ResizeBlocks();});
$("#up").on("click",swipeUp);
$("#down").on("click",swipeDown);
$("#left").on("click",swipeLeft);
$("#right").on("click",swipeRight);

</script>
</html>